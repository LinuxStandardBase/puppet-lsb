#!/bin/sh
#
#	puppet-agent-health-report
#
#	suitable for cron	
#
PATH='/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin'
#
TEMP_PATH=$(mktemp -d --tmpdir puppet-health.XXXXXXXXXX)
RECIPIENTS="licquia@linuxfoundation.org,herrold@owlriver.com"
#
BAS=`basename $0`
STALE_TIME="125"
#	for continuity purposes, chirp once a day
ALIVE=15
POSTALIVE=18
HOUR=`date +%H`
[ 0${HOUR} -ge 0${ALIVE} -a 0${HOUR} -lt 0${POSTALIVE} ] && {
	export CONTINUITY="y"
	}
#
RPT_ROOT="/var/lib/puppet/yaml/node"
#
cd ${RPT_ROOT}

find . -mmin +${STALE_TIME} -type f -print \
  | sort \
  | (while read f; do ls -l $f; done) \
  | cut -d' ' -f6- \
  > $TEMP_PATH/report

if [ -s $TEMP_PATH/report -o "x${CONTINUITY}" != "x" ]; then
  ( echo    "report:      $BAS" ; \
    echo -n "puppet host: " ;  \
    hostname ; \
    echo -n "date:        " ; \
    date ; \
    echo    "continuity:  ${CONTINUITY}" ; \
    echo    "directory:   ${RPT_ROOT} " ; \
    sed -e 's@./@@g' < $TEMP_PATH/report ; \
    echo -n "lines: " ; \
    wc -l $TEMP_PATH/report ; \
    echo "# EOJ" ) | \
  mail -s "LSB Puppet agent health report" \
    ${RECIPIENTS}
fi

rm -rf $TEMP_PATH
#
